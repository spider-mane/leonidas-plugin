#!/usr/bin/env php
<?php

ini_set('xdebug.var_display_max_depth', 10);
ini_set('xdebug.var_display_max_children', 256);
ini_set('xdebug.var_display_max_data', 1024);

################################################################################
# Config
################################################################################
$root = dirname(__DIR__, 1);
$testDir = $root . '/build/test-prefill';
$prefill = $testDir . '/bin/prefill';

$exclude = array_merge(
  [
    '.git',
    '.idea',
    '.vscode',
    'assets/build',
    'assets/dist',
    'assets/node_modules',
    'build',
    'composer.lock',
    'vendor',
    'wordpress',
  ],
  glob("*.code-workspace"),
  glob("**/*.code-workspace"),
);

$answers = [
  'authorName' => 'Method Man',
  'authorEmail' => 'methodman@wutangfinancial.wu',
  'authorGithub' => 'fake-method-man-420',

  'pluginName' => 'Tical',
  'pluginSlug' => 'tical',
  'pluginPrefix' => 'tcl',
  'pluginVersion' => '4.2.0',
  'pluginWebsite' => 'https://github.com/method-man-420/tical',
  'pluginDescription' => "Here comes the ruckus, the motherf*cking ruckus. Thousands of cut-throats and crumb-snatching f*ckers Straight from the brain, I'll be giving you the pain, anger Coming from the 36th Chamber, bang! Tical, hitting with the Buddha-Fist style. Shotgun slamming in your chestpiece, plow! Frame is blown all over the terrain. Like a man without no arms you can't hang. Time for a change of the guard. You've been arrested for lyric fraud now you barred. For real, check it, I pull strings like B.B. King on guitar I'm the true Fist of the North Star!",

  'psr4Namespace' => "MethodMan\\Tical",
];

################################################################################
# Functions (as closures to avoid potential collisions with prefill script)
################################################################################
$copyContents = static function (string $dir, string $copyDir, array $exclude = []) use (&$copyContents): void {
  static $root;
  static $excludedFiles;

  if (!isset($root)) {
    $root = $dir;
  }

  if (!isset($excludedFiles)) {
    $excludedFiles = array_map(function ($file) use ($dir) {
      return "$dir/$file";
    }, $exclude);
  }

  $files = array_filter(scandir($dir), function ($file) {
    return !in_array($file, ['.', '..']);
  });

  foreach ($files as $file) {
    $file = "$dir/$file";
    $copy = $copyDir . '/' . str_replace("$root", '', $file);

    if (in_array($file, $excludedFiles)) {
      continue;
    }

    if (is_dir($file)) {
      mkdir($copy);
      $copyContents($file, $copyDir);
      continue;
    }

    copy($file, $copy);
  }
};

################################################################################
# Run
################################################################################
if (file_exists($testDir)) {
  shell_exec("chmod -R 777 $testDir && rm -rf -f $testDir");
}
mkdir($testDir);
$copyContents($root, $testDir, $exclude);

// Limit exposure! With an immediately invoked closure.
(function () use ($prefill, $answers) {
  $__prefill__ = $prefill;
  $__answers__ = $answers;

  unset($prefill, $answers);

  extract($__answers__);
  require $__prefill__;
})();
